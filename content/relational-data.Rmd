---
title: "Working with Muiltple Data Frames"
author: "Ashley Yue MAO"
date: "2023-1-1"
output:
  html_document: default
  pdf_document: default
editor_options:
  chunk_output_type: inline
  markdown: 
    wrap: 72
---

# 0 Install and load required packages

Load required packages (if no intalled yet, install first)

```{r}
if (!require(tidyverse)) install.packages('tidyverse')
if (!require(nycflights13)) install.packages('nycflights13')

library(tidyverse)
library(nycflights13)
```

(**Optional**) Update R to the latest version

```{r}
# The symbol # is used to add comments or annotation to r code
# Delete the # at the beginning of the following lines and then click run 

# if (!require(installr)) install.packages('installr')
# library(installr)
# updateR()
```

# 1 Get to know `nycflights13`

[R
Document](https://rdocumentation.org/packages/nycflights13/versions/1.0.1)

> This package contains information about all flights that departed from
> NYC (e.g. EWR, JFK and LGA) to destinations in the United States,
> Puerto Rico, and the American Virgin Islands) in 2013: 336,776 flights
> in total. To help understand what causes delays, it also includes a
> number of other useful datasets. ![relational
> diagram](https://r4ds.hadley.nz/diagrams/relational.png)

`flight`: All flights that departed from New York City (NYC) in 2013

```{r}
?flights
View(flights)  
```

`weather`: Hourly meterological data for each airport in NYC:

-   John F.Kennedy International Airport (JFK)
-   LaGuardia Airport (LGA)
-   Newark Liberty International Airport (EWR)

```{r}
?weather
View(weather) 
```

`planes`: Construction information about each plane

```{r}
?planes  
View(planes)
```

`airports`: Airport names and locations

```{r}
?airports  
View(airports)
```

`airline`: Translation between two letter carrier codes and names

```{r}
?airlines
View(airlines)
```

## 1.1 Exercise 1

Why don't we put all the information in a data frame? What are the
benefits of creating multiple data frames?

Hint: Can you imagine what a combined data frame would look like?

# 2 Keys

> A **primary key** uniquely identifies an observation in its own table.

> A **foreign key** uniquely identifies an observation in another table.

> Once you've identified the primary keys in your tables, it's good
> practice to verify that they do indeed uniquely identify each
> observation. One way to do that is to `count()` the primary keys and
> look for entries where n is greater than one:

```{r}
planes %>% 
  count(tailnum) %>% 
  filter(n > 1)
```

## 2.1 Exercise 2

What's the primary key in the other four tables?

```{r}
airports %>% 
  count() %>% 
  filter(n > 1)
```

```{r}
airlines 
```

```{r}
weather 
```

```{r}
flights 
```

Could you find an example of foreign key from those five data frames?

# 3 Join tables

> **Mutating joins** add new ***variables*** to one data frame from
> matching observations in another

> **Filtering joins** filter ***observations*** from one data frame
> based on whether or not they match an observation in the other table

## 3.1 Mutating joins

Mutating join example: add full airline name from `airlines` to the
`flights` data

```{r}
flights %>% 
  select(year:day, hour, tailnum, carrier) %>%  
  left_join(airlines, by = "carrier")
```

It is called "mutating" joins because it could be achieved by using
`mutate()` and R's base subsetting:

```{r}
flights %>% 
  select(year:day, hour, tailnum, carrier) %>% 
  mutate(name = airlines$name[match(carrier, airlines$carrier)]) 

# hard to generalise when you need to match multiple variables, and takes close reading to figure out the overall intent.
```

Let's now use a simple example to see how the four types of mutating
joins differ.

```{r}
x <- tribble( 
  ~key, ~val_x,
     1, "x1",
     2, "x2",
     3, "x3")
y <- tribble(
  ~key, ~val_y,
     1, "y1",
     2, "y2",
     4, "y3")
x
y

# A tribble is used for creating a row-wise, readable tibble in R, which is useful for creating small tables of data. A tibble is a new modern data frame, which keeps important features of a data frame and removes outdated features.
```

### 3.1.1 Inner join

```{r}
x %>% 
  inner_join(y, by = "key")
```

### 3.1.2 Outer join

```{r}
x %>% 
  left_join(y, by = "key")
```

```{r}
x %>% 
  right_join(y, by = "key")
```

```{r}
x %>% 
  full_join(y, by = "key")
```

### 3.1.5 [Exercise](https://r4ds.had.co.nz/relational-data.html#exercises-30) 3

> What weather conditions make it more likely to see a delay?

Hint:

-   Step 1: Join the `weather` and `flights` data frames. What type of
    join to use? What is the key?

    ```{r}
    weather_flights <- weather %>% 
      ?_join(flights, by = "")
    ```

<!-- -->

-   Step 2: Select the necessary variables, weather conditions from
    `temp` to `visib` and `dep_delay`.

    ```{r}
    use_weather_flights <- weather_flights %>% 
      select()
    ```

<!-- -->

-   Step 3: Visualize the relationship between each weather condition
    and departure delay.

    ```{r}
    use_weather_flights %>%
      group_by() %>%
      summarise(delay = mean(dep_delay, na.rm = TRUE)) %>%
      ggplot(aes(x = ?, y = delay)) +
      geom_line() + geom_point()
    ```

## 3.2 Filtering joins

> Similar to mutating joins, but affect the **observations** rather than
> the **variables**:

> `semi_join(x, y)` *keeps* all observations in x that have a match in
> y.

> `anti_join(x, y)` *drops* all observations in x that have a match in
> y.

### 3.2.1 Semi-join

> Semi-joins are useful for matching filtered summary tables back to the
> original rows. For example, imagine you've found the top two most
> popular destinations:

```{r}
top_dest <- flights %>%
  count(dest, sort = TRUE) %>%
  head(2)
top_dest
```

> Now you want to find each flight that went to one of those
> destinations. You could construct a filter yourself:

```{r}
flights %>% 
  filter(dest %in% top_dest$dest)
```

You can also use a semi-join, which does the same thing and could be
more handy when you have multiple variables.

```{r}
flights %>% 
  semi_join(top_dest)
```

### 3.2.2 Anti-join

> Anti-joins are useful for diagnosing join mismatches. For example,
> when connecting `flights` and `planes`, you might be interested to
> know that there are many flights that don't have a match in `planes`:

```{r}
flights %>%
  anti_join(planes, by = "tailnum") %>%
  count(tailnum, sort = TRUE)
```

### 3.2.3 [Exercises](https://r4ds.had.co.nz/relational-data.html#exercises-31) 4

> 2.  Find the 48 hours (over the course of the whole year) that have
>     the worst departure delays. Cross-reference it with the weather
>     data. Can you see any patterns?

Hint:

-   Step 1: To find the 48 hours with the worst departure delays, group
    flights by hour of scheduled departure time and calculate the
    average delay, arrange by delay, and select the 48 observations
    (hours) with the highest average delay.

    ```{r}
    worst_hours <- flights %>%
      mutate(hour = sched_dep_time %/% 100) %>%
      group_by(origin, year, month, day, hour) %>%
      summarise(dep_delay = mean(dep_delay, na.rm = TRUE)) %>%
      ungroup() %>%
      arrange(desc(dep_delay)) %>%
      slice(1:48)
    ```

-   Step 2: To get the weather for these hours, choose a type of
    filtering joins.

    ```{r}
    weather_most_delayed <- ?_join(weather, worst_hours, 
                                      by = c("origin", "year",
                                             "month", "day", "hour"))
    ```

-   Step 3: To get the weather for hours except for those hours, choose
    a type of filtering joins.

    ```{r}
    weather_less_delayed <- ?_join(weather, worst_hours, 
                                      by = c("origin", "year",
                                             "month", "day", "hour"))
    ```

-   Step 4: Compare the average weather conditions in the most and less
    delayed hours.

    ```{r}
    weather_less_delayed <- weather_less_delayed %>%
      mutate(most_delayed = 'no') 

    weather_most_delayed %>%
      mutate(most_delayed = 'yes') %>%
      rows_append(weather_less_delayed) %>%
      group_by(most_delayed) %>%
      summarise(temp = mean(temp, na.rm = TRUE),
                dewp = mean(dewp, na.rm = TRUE),
                humid = mean(humid, na.rm = TRUE),
                wind_speed = mean(wind_speed, na.rm = TRUE),
                precip = mean(precip, na.rm = TRUE),
                visib = mean(visib, na.rm = TRUE))
    ```
